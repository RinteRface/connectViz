---
title: "RStudio Connect data"
author: "David Granjon"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme:
      version: 4
runtime: shiny
---

```{r setup, include=FALSE}
library(connectapi) # Tested with 0.1.0.9031
library(connectViz)
library(dplyr)
rsc_client <- create_rsc_client()
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

```{r database}
# Get raw data from RSC database
apps_usage <- rsc_client %>% get_usage_shiny(limit = Inf)
rsc_content <- rsc_client %>% get_content()
rsc_users <- rsc_client %>% get_users(limit = Inf)
publishers <- rsc_users %>% filter(user_role == "publisher") 
shiny_apps <- rsc_content %>% filter(app_mode == "shiny")

# TO DO
# rsc_static <- rsc_client %>% get_usage_static(limit = Inf)
```

### General metrics

```{r general-metric}
general_metrics <- list(
  "Onboarded Users (n)" = nrow(rsc_users),
  "Publishers (n)" = nrow(publishers),
  "Deployments (n)" = nrow(rsc_content),
  "Shiny Apps (n)" = nrow(shiny_apps)
)

shiny::fluidRow(
  align = "center",
  purrr::map(
    seq_along(general_metrics),
    function(i) {
      
      shinydashboard::infoBox(
        value = general_metrics[[i]],
        title = names(general_metrics)[[i]]
      )
    }
  )
)
```

### Shiny Apps usage

#### Most used apps

```{r}
apps_ranking <- create_app_ranking(rsc_content, rsc_users, apps_usage)
create_app_ranking_table(apps_ranking)
```

#### Daily app usage

```{r}
create_app_daily_usage(apps_ranking[[2]], input)
```

#### Cumulated duration / user

```{r duration-plot}
create_cumulated_duration_per_user(apps_ranking[[1]], input)
```

#### Number Hits / user

```{r sessions-plot}
create_cumulated_hits_per_user(apps_ranking[[1]], input)
```


### Developers data


#### Developers ranking (number of deployments: api, static, shiny, rmd, ...)

```{r developers-ranking}
developers_apps_ranking <- create_dev_ranking(rsc_users, rsc_content)
create_dev_ranking_chart(developers_apps_ranking, input)
```

#### Developer projects overview

```{r}
create_dev_project_overview(developers_apps_ranking, rsc_client, apps_ranking[[1]], input)
```


### Other data

#### Users repartition (%)

```{r user-repartition}
# I realized some users are not active (ie active_time is NA).
# Maybe to remove from the viz in the future?
sort_users_by_role(rsc_users) %>% create_pie_chart("user_role")
```

#### Content access

How do people protect their content?

```{r content-access-type}
sort_content_by_access(rsc_content) %>% create_pie_chart("access_type")
```


#### R versions

What are the R versions used?

```{r content-r-version}
sort_content_by_rversion(rsc_content) %>% create_pie_chart("r_version")
```

#### Content type

```{r content-type}
sort_content_by_appmode(rsc_content) %>% create_pie_chart("app_mode")
```

<!--
#### Running user

What is the preferred running user?

```{r running-user}
rsc_content %>% 
group_by(run_as_current_user) %>% 
summarize(n = n()) %>% 
mutate(Percentage = round(n / sum(n) * 100)) %>% 
e_charts(run_as_current_user) %>% 
e_pie(Percentage, radius = c("50%", "70%")) %>% 
e_title("Run as current user? (%)") %>% 
e_tooltip()
```

-->
